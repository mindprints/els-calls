<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Call Settings Dashboard</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                    sans-serif;
                margin: 2em;
                background-color: #f4f4f9;
                color: #333;
            }
            h1,
            h3 {
                color: #444;
            }
            form {
                background: #fff;
                padding: 1.5em;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 2em;
            }
            input[type="text"],
            input[type="time"],
            select {
                width: 100%;
                padding: 8px;
                margin: 6px 0 16px;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #4caf50;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
            }
            button:hover {
                background-color: #45a049;
            }
            button.delete {
                background-color: #f44336;
                padding: 5px 10px;
                font-size: 0.8em;
            }
            button.delete:hover {
                background-color: #da190b;
            }
            hr {
                border: 0;
                height: 1px;
                background: #ddd;
                margin: 2em 0;
            }
            .section {
                margin-bottom: 2rem;
            }
            #audio-list label,
            #schedule-list div {
                margin-bottom: 0.5rem;
                display: block;
            }
            #schedule-list .slot {
                background-color: #e9eef6;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        </style>
    </head>
    <body>
        <h1>Call Settings Dashboard</h1>

        <!-- General Settings -->
        <div class="section">
            <h3>General Settings</h3>
            <form id="settings-form">
                <label for="mil_number">MIL Number:</label><br />
                <input
                    type="text"
                    id="mil_number"
                    name="mil_number"
                /><br /><br />

                <label for="fallback_number">Fallback Number:</label><br />
                <input
                    type="text"
                    id="fallback_number"
                    name="fallback_number"
                /><br /><br />

                <label>Default Active Audio (when no schedule matches):</label>
                <div id="audio-list">
                    <p>Loading audio files...</p>
                </div>
                <br />

                <button type="submit">Save General Settings</button>
            </form>
        </div>

        <hr />

        <!-- Schedule Manager -->
        <div class="section">
            <h3>Schedule Manager</h3>
            <form id="schedule-form">
                <label for="schedule_audio_file">Audio File:</label>
                <select id="schedule_audio_file" required></select>

                <label for="start_time">Start Time (UTC):</label>
                <input type="time" id="start_time" required />

                <label for="end_time">End Time (UTC):</label>
                <input type="time" id="end_time" required />

                <button type="submit">Add to Schedule</button>
            </form>

            <h4>Current Schedule</h4>
            <div id="schedule-list">
                <p>Loading schedule...</p>
            </div>
        </div>

        <hr />

        <!-- Upload Audio -->
        <div class="section">
            <h3>Upload New Audio</h3>
            <form id="upload-form" enctype="multipart/form-data">
                <label for="audio_file">Audio file (MP3 only):</label><br />
                <input
                    type="file"
                    id="audio_file"
                    name="audio_file"
                    accept="audio/mpeg"
                /><br /><br />
                <button type="submit">Upload</button>
            </form>
        </div>

        <script>
            window.addEventListener("DOMContentLoaded", () => {
                // Main Form Elements
                const settingsForm = document.getElementById("settings-form");
                const milNumberInput = document.getElementById("mil_number");
                const fallbackNumberInput =
                    document.getElementById("fallback_number");
                const audioListDiv = document.getElementById("audio-list");

                // Upload Form Elements
                const uploadForm = document.getElementById("upload-form");
                const audioFileInput = document.getElementById("audio_file");

                // Schedule Form Elements
                const scheduleForm = document.getElementById("schedule-form");
                const scheduleAudioFileSelect = document.getElementById(
                    "schedule_audio_file",
                );
                const startTimeInput = document.getElementById("start_time");
                const endTimeInput = document.getElementById("end_time");
                const scheduleListDiv =
                    document.getElementById("schedule-list");

                // --- DATA LOADING AND RENDERING ---

                function loadData() {
                    Promise.all([
                        fetch("/settings").then((res) => res.json()),
                        fetch("/audio_files").then((res) => res.json()),
                    ])
                        .then(([settings, files]) => {
                            renderAudioLists(settings, files);
                            renderSettingsForm(settings);
                            renderSchedule(settings.SCHEDULE || []);
                        })
                        .catch((error) => {
                            console.error("Error loading data:", error);
                            alert("Error loading initial data.");
                        });
                }

                function renderAudioLists(settings, files) {
                    audioListDiv.innerHTML = "";
                    scheduleAudioFileSelect.innerHTML = "";

                    if (!files || files.length === 0) {
                        audioListDiv.innerHTML =
                            "<p>No audio files uploaded.</p>";
                        return;
                    }

                    // For default audio selection (radio buttons)
                    files.forEach((file) => {
                        const radioId = `audio-radio-${file}`;
                        const radio = document.createElement("input");
                        radio.type = "radio";
                        radio.name = "active_audio";
                        radio.id = radioId;
                        radio.value = file;
                        if (file === settings.ACTIVE_AUDIO_FILE) {
                            radio.checked = true;
                        }

                        const label = document.createElement("label");
                        label.htmlFor = radioId;
                        label.textContent = ` ${file}`;

                        audioListDiv.appendChild(radio);
                        audioListDiv.appendChild(label);
                        audioListDiv.appendChild(document.createElement("br"));
                    });

                    // For schedule form (dropdown)
                    files.forEach((file) => {
                        const option = document.createElement("option");
                        option.value = file;
                        option.textContent = file;
                        scheduleAudioFileSelect.appendChild(option);
                    });
                }

                function renderSettingsForm(settings) {
                    milNumberInput.value = settings.MIL_NUMBER;
                    fallbackNumberInput.value = settings.FALLBACK_NUMBER;
                }

                function renderSchedule(schedule) {
                    scheduleListDiv.innerHTML = "";
                    if (!schedule || schedule.length === 0) {
                        scheduleListDiv.innerHTML =
                            "<p>No scheduled items.</p>";
                        return;
                    }

                    schedule.forEach((slot, index) => {
                        const slotDiv = document.createElement("div");
                        slotDiv.className = "slot";

                        const text = document.createElement("span");
                        text.textContent = `Play "${slot.audio_file}" from ${slot.start_time} to ${slot.end_time}`;

                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "Delete";
                        deleteBtn.className = "delete";
                        deleteBtn.dataset.index = index; // Store index for deletion

                        slotDiv.appendChild(text);
                        slotDiv.appendChild(deleteBtn);
                        scheduleListDiv.appendChild(slotDiv);
                    });
                }

                // --- EVENT LISTENERS ---

                // Handle general settings form submission
                settingsForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const selectedAudio = document.querySelector(
                        'input[name="active_audio"]:checked',
                    );
                    const newData = {
                        MIL_NUMBER: milNumberInput.value,
                        FALLBACK_NUMBER: fallbackNumberInput.value,
                        ACTIVE_AUDIO_FILE: selectedAudio
                            ? selectedAudio.value
                            : null,
                    };

                    fetch("/settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newData),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Settings saved successfully!");
                                loadData();
                            } else {
                                alert("Error saving settings: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving settings:", error);
                            alert("Error saving settings.");
                        });
                });

                // Handle schedule form submission
                scheduleForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const newSlot = {
                        audio_file: scheduleAudioFileSelect.value,
                        start_time: startTimeInput.value,
                        end_time: endTimeInput.value,
                    };

                    fetch("/schedule", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newSlot),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Schedule updated!");
                                renderSchedule(data.schedule);
                                scheduleForm.reset();
                            } else {
                                alert(
                                    "Error updating schedule: " + data.message,
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Error updating schedule:", error);
                            alert("Error updating schedule.");
                        });
                });

                // Handle deleting a schedule item (using event delegation)
                scheduleListDiv.addEventListener("click", (event) => {
                    if (event.target.classList.contains("delete")) {
                        const index = event.target.dataset.index;
                        if (
                            !confirm(
                                "Are you sure you want to delete this schedule item?",
                            )
                        ) {
                            return;
                        }

                        fetch(`/schedule/${index}`, { method: "DELETE" })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.status === "success") {
                                    alert("Schedule item deleted.");
                                    renderSchedule(data.schedule);
                                } else {
                                    alert(
                                        "Error deleting item: " + data.message,
                                    );
                                }
                            })
                            .catch((error) => {
                                console.error("Error deleting item:", error);
                                alert("Error deleting item.");
                            });
                    }
                });

                // Handle upload form submission
                uploadForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    if (!audioFileInput.files.length) {
                        alert("Please select a file to upload.");
                        return;
                    }
                    const formData = new FormData(uploadForm);

                    fetch("/upload_audio", { method: "POST", body: formData })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("File uploaded successfully!");
                                uploadForm.reset();
                                loadData(); // Refresh all data to show new file
                            } else {
                                alert("Error uploading file: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error uploading file:", error);
                            alert("An error occurred during file upload.");
                        });
                });

                // Initial load
                loadData();
            });
        </script>
    </body>
</html>
