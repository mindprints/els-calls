<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Call Settings Dashboard</title>
        <script src="https://unpkg.com/lamejs@1.2.1/lame.min.js"></script>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                    sans-serif;
                margin: 2em;
                background-color: #f4f4f9;
                color: #333;
            }
            h1,
            h3,
            h4 {
                color: #444;
            }
            .section {
                background: #fff;
                padding: 1.5em;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }
            input[type="text"],
            input[type="time"],
            input[type="number"],
            select,
            input[type="file"] {
                width: 100%;
                padding: 8px;
                margin: 6px 0 16px;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #4caf50;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
            }
            button:hover {
                background-color: #45a049;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            button.delete {
                background-color: #f44336;
                padding: 5px 10px;
                font-size: 0.8em;
            }
            button.delete:hover {
                background-color: #da190b;
            }
            hr {
                border: 0;
                height: 1px;
                background: #ddd;
                margin: 2em 0;
            }
            .audio-item {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
            }
            .audio-item label {
                flex-grow: 1;
                margin: 0 8px;
            }
            .slot {
                background-color: #e9eef6;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .voice-message-item {
                padding: 8px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: background-color 0.2s;
            }
            .voice-message-item:hover {
                background-color: #f5f5f5;
            }
            .voice-message-item:active {
                background-color: #e0e0e0;
            }
            .ai-voice-chat-slot {
                background-color: #e8f4fd;
                border-left: 4px solid #2c5aa0;
            }
            .recording-active {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
                100% {
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body>
        <h1>Call Settings Dashboard</h1>

        <!-- AI Conversation Settings -->
        <div class="section">
            <h3>AI Conversation Settings</h3>
            <form id="ai-settings-form" onsubmit="return false;">
                <label>
                    <input type="checkbox" id="ai_enabled" name="ai_enabled" />
                    Enable AI Replies
                </label>
                <br /><br />

                <label for="max_turns">Maximum Conversation Turns:</label>
                <input
                    type="number"
                    id="max_turns"
                    name="max_turns"
                    min="1"
                    max="5"
                    value="3"
                />

                <label for="language">Language:</label>
                <select id="language" name="language">
                    <option value="sv">Swedish</option>
                    <option value="en">English</option>
                </select>

                <button type="submit" id="save-ai-settings-btn">
                    Save AI Settings
                </button>
            </form>
        </div>

        <hr />

        <!-- General Settings -->
        <div class="section">
            <h3>General Settings</h3>
            <form id="settings-form" onsubmit="return false;">
                <label for="mil_number">MIL Number:</label>
                <input type="text" id="mil_number" name="mil_number" />

                <label for="fallback_number">Fallback Number:</label>
                <input
                    type="text"
                    id="fallback_number"
                    name="fallback_number"
                />

                <label>Default Active Audio (when no schedule matches):</label>
                <div id="audio-list">
                    <p id="audio-loading">Loading audio files...</p>
                </div>
                <br />

                <button type="submit" id="save-settings-btn">
                    Save General Settings
                </button>
            </form>
        </div>

        <hr />

        <!-- Schedule Manager -->
        <div class="section">
            <h3>Schedule Manager</h3>
            <form id="schedule-form" onsubmit="return false;">
                <label for="schedule_audio_file">Audio File:</label>
                <select id="schedule_audio_file" required></select>

                <label for="start_time">Start Time (UTC):</label>
                <input type="time" id="start_time" required />

                <label for="end_time">End Time (UTC):</label>
                <input type="time" id="end_time" required />

                <div style="margin: 10px 0">
                    <input
                        type="checkbox"
                        id="ai-voice-chat-enabled"
                        name="ai_voice_chat_enabled"
                    />
                    <label
                        for="ai-voice-chat-enabled"
                        style="display: inline; margin-left: 5px"
                    >
                        Enable AI Voice Chat for this slot
                    </label>
                    <span
                        style="
                            margin-left: 8px;
                            color: #666;
                            cursor: help;
                            font-size: 0.9em;
                        "
                        title="When enabled, calls during this time slot will use AI conversation instead of playing the selected audio file"
                    >
                        (‚ùì)
                    </span>
                </div>

                <button type="submit">Add to Schedule</button>
            </form>

            <h4>Current Schedule</h4>
            <div id="schedule-list">
                <p id="schedule-loading">Loading schedule...</p>
            </div>
        </div>

        <hr />

        <!-- Voice Messages Review -->
        <div class="section">
            <h3>Voice Messages Review</h3>
            <p>Click on any voice message to play it:</p>
            <div
                id="voice-messages-list"
                style="
                    max-height: 300px;
                    overflow-y: auto;
                    border: 1px solid #ccc;
                    padding: 10px;
                "
            >
                <p id="voice-messages-loading">Loading voice messages...</p>
            </div>
        </div>

        <hr />

        <!-- Record New Audio -->
        <div class="section" id="record-section">
            <h3>Record New Audio</h3>
            <div id="recorder-ui">
                <button type="button" id="start-record-btn">
                    Start Recording
                </button>
                <button type="button" id="stop-record-btn" disabled>
                    Stop Recording
                </button>
                <p>
                    <strong>Status:</strong>
                    <span id="record-status">Ready</span>
                </p>
                <div
                    id="recording-indicator"
                    class="recording-active"
                    style="
                        display: none;
                        color: red;
                        font-weight: bold;
                        margin: 10px 0;
                        padding: 10px;
                        border-radius: 4px;
                        background-color: #ffe6e6;
                        border: 1px solid #ffcccc;
                    "
                >
                    üî¥ RECORDING IN PROGRESS
                </div>
                <audio
                    id="preview-player"
                    controls
                    style="display: none; margin-top: 1em; width: 100%"
                ></audio>
                <div
                    id="preview-controls"
                    style="display: none; margin-top: 1em"
                >
                    <button type="button" id="save-record-btn">
                        Save Recording
                    </button>
                    <button
                        type="button"
                        id="discard-record-btn"
                        class="delete"
                    >
                        Discard
                    </button>
                </div>
            </div>
        </div>

        <hr />

        <!-- Upload Audio -->
        <div class="section">
            <h3>Upload New Audio</h3>
            <form id="upload-form" enctype="multipart/form-data">
                <label for="audio_file">Audio file (MP3 only):</label><br />
                <input
                    type="file"
                    id="audio_file"
                    name="audio_file"
                    accept="audio/mpeg"
                /><br /><br />
                <button type="submit">Upload</button>
            </form>
        </div>

        <script>
            window.addEventListener("DOMContentLoaded", () => {
                // --- ELEMENT SELECTORS ---
                const settingsForm = document.getElementById("settings-form");
                const milNumberInput = document.getElementById("mil_number");
                const fallbackNumberInput =
                    document.getElementById("fallback_number");
                const audioListDiv = document.getElementById("audio-list");

                const uploadForm = document.getElementById("upload-form");
                const audioFileInput = document.getElementById("audio_file");

                const scheduleForm = document.getElementById("schedule-form");
                const scheduleAudioFileSelect = document.getElementById(
                    "schedule_audio_file",
                );
                const startTimeInput = document.getElementById("start_time");
                const endTimeInput = document.getElementById("end_time");
                const scheduleListDiv =
                    document.getElementById("schedule-list");

                const recordSection = document.getElementById("record-section");
                const startRecordBtn =
                    document.getElementById("start-record-btn");
                const stopRecordBtn =
                    document.getElementById("stop-record-btn");
                const recordStatus = document.getElementById("record-status");
                const recordingIndicator = document.getElementById(
                    "recording-indicator",
                );
                const previewPlayer = document.getElementById("preview-player");
                const previewControls =
                    document.getElementById("preview-controls");
                const saveRecordBtn =
                    document.getElementById("save-record-btn");
                const discardRecordBtn =
                    document.getElementById("discard-record-btn");

                const aiSettingsForm =
                    document.getElementById("ai-settings-form");
                const aiEnabledCheckbox = document.getElementById("ai_enabled");
                const maxTurnsInput = document.getElementById("max_turns");
                const languageSelect = document.getElementById("language");

                // --- STATE VARIABLES ---
                let mediaRecorder;
                let audioChunks = [];
                let audioBlob;

                // --- DATA LOADING & RENDERING ---
                function loadData() {
                    // Show loading states
                    const audioLoading =
                        document.getElementById("audio-loading");
                    if (audioLoading) audioLoading.textContent = "Loading...";
                    const scheduleLoading =
                        document.getElementById("schedule-loading");
                    if (scheduleLoading)
                        scheduleLoading.textContent = "Loading...";
                    const voiceMessagesLoading = document.getElementById(
                        "voice-messages-loading",
                    );
                    if (voiceMessagesLoading)
                        voiceMessagesLoading.textContent = "Loading...";

                    Promise.all([
                        fetch("/settings").then((res) => {
                            if (!res.ok) {
                                throw new Error(
                                    `Settings failed: ${res.status}`,
                                );
                            }
                            return res.json();
                        }),
                        fetch("/audio_files").then((res) => {
                            if (!res.ok) {
                                throw new Error(
                                    `Audio files failed: ${res.status}`,
                                );
                            }
                            return res.json();
                        }),
                    ])
                        .then(([settings, files]) => {
                            renderAudioLists(settings, files);
                            renderSettingsForm(settings);
                            renderSchedule(settings.SCHEDULE || []);
                        })
                        .catch((error) => {
                            console.error("Error loading initial data:", error);

                            // Show specific error messages
                            // Show specific error messages safely
                            const audioLoading =
                                document.getElementById("audio-loading");
                            const scheduleLoading =
                                document.getElementById("schedule-loading");
                            const voiceMessagesLoading =
                                document.getElementById(
                                    "voice-messages-loading",
                                );

                            if (audioLoading)
                                audioLoading.textContent =
                                    "Error loading audio files";
                            if (scheduleLoading)
                                scheduleLoading.textContent =
                                    "Error loading schedule";
                            if (voiceMessagesLoading)
                                voiceMessagesLoading.textContent =
                                    "Error loading voice messages";

                            alert("Error loading data: " + error.message);
                        });
                }

                function renderAudioLists(settings, files) {
                    audioListDiv.innerHTML = "";
                    scheduleAudioFileSelect.innerHTML = "";
                    const voiceMessagesList = document.getElementById(
                        "voice-messages-list",
                    );
                    if (voiceMessagesList) {
                        voiceMessagesList.innerHTML = "";
                    }

                    // Hide loading indicators safely
                    const audioLoading =
                        document.getElementById("audio-loading");
                    const voiceMessagesLoading = document.getElementById(
                        "voice-messages-loading",
                    );
                    if (audioLoading) audioLoading.style.display = "none";
                    if (voiceMessagesLoading)
                        voiceMessagesLoading.style.display = "none";

                    if (!files || files.length === 0) {
                        audioListDiv.innerHTML =
                            "<p>No audio files uploaded.</p>";
                        if (voiceMessagesList) {
                            voiceMessagesList.innerHTML =
                                "<p>No voice messages available.</p>";
                        }
                        return;
                    }

                    // Separate AI voice chat files from regular audio files
                    const aiVoiceFiles = [
                        "hello.mp3",
                        "waiting.mp3",
                        "goodbye.mp3",
                        "fallback.mp3",
                    ];
                    const regularFiles = files.filter(
                        (file) => !aiVoiceFiles.includes(file),
                    );
                    const aiFiles = files.filter((file) =>
                        aiVoiceFiles.includes(file),
                    );

                    // Render regular audio files first
                    if (regularFiles.length > 0) {
                        const regularHeader = document.createElement("h4");
                        regularHeader.textContent = "Regular Audio Files";
                        regularHeader.style.marginTop = "1em";
                        audioListDiv.appendChild(regularHeader);

                        regularFiles.forEach((file) => {
                            createAudioFileItem(file, settings, audioListDiv);
                        });
                    }

                    // Render AI voice chat files separately
                    if (aiFiles.length > 0) {
                        const aiHeader = document.createElement("h4");
                        aiHeader.textContent = "AI Voice Chat Files";
                        aiHeader.style.marginTop = "1em";
                        aiHeader.style.color = "#2c5aa0";
                        audioListDiv.appendChild(aiHeader);

                        aiFiles.forEach((file) => {
                            createAudioFileItem(file, settings, audioListDiv);
                        });
                    }

                    // Add all files to schedule dropdown
                    files.forEach((file) => {
                        const option = document.createElement("option");
                        option.value = file;
                        option.textContent = file;
                        scheduleAudioFileSelect.appendChild(option);
                    });

                    // Create voice messages review list
                    if (voiceMessagesList) {
                        files.forEach((file) => {
                            const messageDiv = document.createElement("div");
                            messageDiv.className = "voice-message-item";
                            messageDiv.style.padding = "8px";
                            messageDiv.style.borderBottom = "1px solid #eee";
                            messageDiv.style.cursor = "pointer";
                            messageDiv.style.display = "flex";
                            messageDiv.style.alignItems = "center";
                            messageDiv.style.gap = "10px";

                            const playIcon = document.createElement("span");
                            playIcon.textContent = "‚ñ∂Ô∏è";
                            playIcon.style.fontSize = "12px";

                            const fileName = document.createElement("span");
                            fileName.textContent = file;

                            const audioPlayer = document.createElement("audio");
                            audioPlayer.style.display = "none";
                            audioPlayer.src = `/audio/${file}`;
                            audioPlayer.preload = "metadata";

                            messageDiv.appendChild(playIcon);
                            messageDiv.appendChild(fileName);
                            messageDiv.appendChild(audioPlayer);
                            voiceMessagesList.appendChild(messageDiv);

                            messageDiv.addEventListener("click", () => {
                                if (audioPlayer.paused) {
                                    audioPlayer.play();
                                    playIcon.textContent = "‚è∏Ô∏è";
                                } else {
                                    audioPlayer.pause();
                                    playIcon.textContent = "‚ñ∂Ô∏è";
                                }
                            });

                            audioPlayer.addEventListener("ended", () => {
                                playIcon.textContent = "‚ñ∂Ô∏è";
                            });

                            audioPlayer.addEventListener("pause", () => {
                                playIcon.textContent = "‚ñ∂Ô∏è";
                            });
                        });
                    }
                }

                function createAudioFileItem(file, settings, container) {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "audio-item";

                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = "active_audio";
                    radio.id = `audio-radio-${file}`;
                    radio.value = file;
                    if (file === settings.ACTIVE_AUDIO_FILE) {
                        radio.checked = true;
                    }

                    const label = document.createElement("label");
                    label.htmlFor = `audio-radio-${file}`;
                    label.textContent = file;

                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Delete";
                    deleteBtn.className = "delete audio-delete";
                    deleteBtn.type = "button";
                    deleteBtn.dataset.filename = file;

                    itemDiv.appendChild(radio);
                    itemDiv.appendChild(label);
                    itemDiv.appendChild(deleteBtn);
                    container.appendChild(itemDiv);
                }

                function renderSettingsForm(settings) {
                    milNumberInput.value = settings.MIL_NUMBER;
                    fallbackNumberInput.value = settings.FALLBACK_NUMBER;

                    // Render AI settings
                    aiEnabledCheckbox.checked =
                        settings.AI_REPLIES_ENABLED || false;
                    maxTurnsInput.value = settings.MAX_TURNS || 3;
                    languageSelect.value = settings.LANG || "sv";
                }

                function renderSchedule(schedule) {
                    scheduleListDiv.innerHTML = "";
                    // Hide loading indicator safely
                    const scheduleLoading =
                        document.getElementById("schedule-loading");
                    if (scheduleLoading) scheduleLoading.style.display = "none";

                    if (!schedule || schedule.length === 0) {
                        scheduleListDiv.innerHTML =
                            "<p>No scheduled items.</p>";
                        return;
                    }
                    schedule.forEach((slot, index) => {
                        const slotDiv = document.createElement("div");
                        slotDiv.className = "slot";

                        // Check if this is an AI voice chat slot
                        const aiVoiceFiles = [
                            "hello.mp3",
                            "waiting.mp3",
                            "goodbye.mp3",
                            "fallback.mp3",
                        ];
                        const isAIVoiceFile = aiVoiceFiles.includes(
                            slot.audio_file,
                        );
                        const isAIVoiceChat =
                            slot.ai_voice_chat_enabled || isAIVoiceFile;

                        if (isAIVoiceChat) {
                            slotDiv.classList.add("ai-voice-chat-slot");
                        }

                        const text = document.createElement("span");
                        if (isAIVoiceChat) {
                            text.innerHTML = `üéôÔ∏è <strong>AI Voice Chat</strong> - "${slot.audio_file}" from ${slot.start_time} to ${slot.end_time}`;
                            text.style.color = "#2c5aa0";
                        } else {
                            text.textContent = `Play "${slot.audio_file}" from ${slot.start_time} to ${slot.end_time}`;
                        }

                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "Delete";
                        deleteBtn.className = "delete";
                        deleteBtn.dataset.index = index;
                        slotDiv.appendChild(text);
                        slotDiv.appendChild(deleteBtn);
                        scheduleListDiv.appendChild(slotDiv);
                    });
                }

                // --- RECORDER LOGIC ---
                function initializeRecorder() {
                    if (
                        !navigator.mediaDevices ||
                        !navigator.mediaDevices.getUserMedia
                    ) {
                        recordSection.innerHTML =
                            "<h3>Recording not supported</h3><p>Direct audio recording is not available on this browser (it requires HTTPS and a modern browser).</p>";
                        return;
                    }
                    startRecordBtn.addEventListener("click", startRecording);
                    stopRecordBtn.addEventListener("click", stopRecording);
                    saveRecordBtn.addEventListener("click", saveRecording);
                    discardRecordBtn.addEventListener(
                        "click",
                        resetRecordingState,
                    );
                    resetRecordingState();
                }

                function resetRecordingState() {
                    startRecordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                    saveRecordBtn.disabled = true;
                    discardRecordBtn.disabled = true;
                    recordStatus.textContent = "Ready";
                    recordingIndicator.style.display = "none";
                    recordingIndicator.classList.remove("recording-active");
                    previewPlayer.style.display = "none";
                    previewControls.style.display = "none";
                    if (previewPlayer.src) {
                        URL.revokeObjectURL(previewPlayer.src);
                    }
                    previewPlayer.removeAttribute("src");
                    audioChunks = [];
                    audioBlob = null;
                }

                function startRecording() {
                    navigator.mediaDevices
                        .getUserMedia({ audio: true })
                        .then((stream) => {
                            mediaRecorder = new MediaRecorder(stream);
                            mediaRecorder.ondataavailable = (event) => {
                                audioChunks.push(event.data);
                            };
                            mediaRecorder.onstop = () => {
                                audioBlob = new Blob(audioChunks, {
                                    type: "audio/wav",
                                });
                                const audioUrl = URL.createObjectURL(audioBlob);
                                previewPlayer.src = audioUrl;
                                previewPlayer.style.display = "block";
                                previewControls.style.display = "block";
                                saveRecordBtn.disabled = false;
                                discardRecordBtn.disabled = false;
                                recordStatus.textContent = "Preview Ready";
                            };
                            startRecordBtn.disabled = true;
                            stopRecordBtn.disabled = false;
                            recordStatus.textContent = "Recording...";
                            recordingIndicator.style.display = "block";
                            recordingIndicator.classList.add(
                                "recording-active",
                            );
                            mediaRecorder.start();
                        })
                        .catch((err) => {
                            console.error("Error accessing microphone:", err);
                            alert(
                                "Could not access microphone. Please check browser permissions.",
                            );
                        });
                }

                function stopRecording() {
                    mediaRecorder.stop();
                    recordingIndicator.style.display = "none";
                    recordingIndicator.classList.remove("recording-active");
                    mediaRecorder.stream
                        .getTracks()
                        .forEach((track) => track.stop()); // Release microphone
                    stopRecordBtn.disabled = true;
                }

                function saveRecording() {
                    const filename = prompt(
                        "Please enter a filename for your recording (without extension):",
                    );
                    if (filename && filename.trim()) {
                        encodeAndUpload(audioBlob, `${filename.trim()}.mp3`);
                    } else if (filename !== null) {
                        alert("Filename cannot be empty.");
                    }
                }

                function encodeAndUpload(blob, filename) {
                    recordStatus.textContent = "Encoding to MP3...";
                    saveRecordBtn.disabled = true;
                    discardRecordBtn.disabled = true;

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const audioContext = new (window.AudioContext ||
                            window.webkitAudioContext)();
                        audioContext
                            .decodeAudioData(event.target.result)
                            .then((buffer) => {
                                const mp3encoder = new lamejs.Mp3Encoder(
                                    1,
                                    buffer.sampleRate,
                                    128,
                                );
                                const samples = buffer.getChannelData(0);
                                const mp3Data = [];
                                const sampleBlockSize = 1152;

                                for (
                                    let i = 0;
                                    i < samples.length;
                                    i += sampleBlockSize
                                ) {
                                    const sampleChunk = samples.subarray(
                                        i,
                                        i + sampleBlockSize,
                                    );
                                    const mp3buf =
                                        mp3encoder.encodeBuffer(sampleChunk);
                                    if (mp3buf.length > 0) {
                                        mp3Data.push(mp3buf);
                                    }
                                }

                                const end = mp3encoder.flush();
                                if (end.length > 0) {
                                    mp3Data.push(end);
                                }

                                const mp3Blob = new Blob(mp3Data, {
                                    type: "audio/mpeg",
                                });
                                const formData = new FormData();
                                formData.append(
                                    "audio_file",
                                    mp3Blob,
                                    filename,
                                );

                                fetch("/upload_audio", {
                                    method: "POST",
                                    body: formData,
                                })
                                    .then((res) => res.json())
                                    .then((data) => {
                                        if (data.status === "success") {
                                            alert(
                                                "Recording saved successfully!",
                                            );
                                            resetRecordingState();
                                            loadData();
                                        } else {
                                            alert(
                                                "Error saving recording: " +
                                                    data.message,
                                            );
                                        }
                                    })
                                    .catch((error) => {
                                        console.error(
                                            "Error saving recording:",
                                            error,
                                        );
                                        alert(
                                            "An error occurred while saving the recording.",
                                        );
                                    });
                            });
                    };
                    reader.readAsArrayBuffer(blob);
                }

                // --- EVENT HANDLERS ---

                // AI Settings Form
                aiSettingsForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const aiData = {
                        AI_REPLIES_ENABLED: aiEnabledCheckbox.checked,
                        MAX_TURNS: parseInt(maxTurnsInput.value),
                        LANG: languageSelect.value,
                    };

                    fetch("/settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(aiData),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("AI settings saved successfully!");
                                loadData();
                            } else {
                                alert(
                                    "Error saving AI settings: " + data.message,
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving AI settings:", error);
                            alert("Error saving AI settings.");
                        });
                });

                // General Settings Form
                settingsForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const selectedAudio = document.querySelector(
                        'input[name="active_audio"]:checked',
                    );
                    const newData = {
                        MIL_NUMBER: milNumberInput.value,
                        FALLBACK_NUMBER: fallbackNumberInput.value,
                        ACTIVE_AUDIO_FILE: selectedAudio
                            ? selectedAudio.value
                            : null,
                    };

                    fetch("/settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newData),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Settings saved successfully!");
                                loadData();
                            } else {
                                alert("Error saving settings: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving settings:", error);
                            alert("Error saving settings.");
                        });
                });

                // Audio File Deletion
                audioListDiv.addEventListener("click", (event) => {
                    const target = event.target;
                    if (target.classList.contains("audio-delete")) {
                        const filename = target.dataset.filename;
                        if (
                            !confirm(
                                `Are you sure you want to delete "${filename}"?`,
                            )
                        ) {
                            return;
                        }

                        fetch(`/audio/${filename}`, { method: "DELETE" })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.status === "success") {
                                    alert(data.message);
                                    loadData();
                                } else {
                                    alert(`Error: ${data.message}`);
                                }
                            })
                            .catch((error) => {
                                console.error(
                                    "Error deleting audio file:",
                                    error,
                                );
                                alert(
                                    "An error occurred while trying to delete the file.",
                                );
                            });
                    }
                });

                // Schedule Form
                scheduleForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const newSlot = {
                        audio_file: scheduleAudioFileSelect.value,
                        start_time: startTimeInput.value,
                        end_time: endTimeInput.value,
                        ai_voice_chat_enabled: document.getElementById(
                            "ai-voice-chat-enabled",
                        ).checked,
                    };

                    fetch("/schedule", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newSlot),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Schedule updated!");
                                renderSchedule(data.schedule);
                                scheduleForm.reset();
                                // Refresh audio files to update schedule dropdown
                                loadData();
                            } else {
                                // Show detailed error message for conflicts
                                if (
                                    data.status === "error" &&
                                    data.message.includes("conflict")
                                ) {
                                    alert(
                                        "‚ùå Schedule Conflict: " +
                                            data.message +
                                            "\n\nPlease choose a different time slot.",
                                    );
                                } else {
                                    alert(
                                        "Error updating schedule: " +
                                            data.message,
                                    );
                                }
                            }
                        })
                        .catch((error) => {
                            console.error("Error updating schedule:", error);
                            alert("Error updating schedule.");
                        });
                });

                // Schedule Deletion
                scheduleListDiv.addEventListener("click", (event) => {
                    if (event.target.classList.contains("delete")) {
                        const index = event.target.dataset.index;
                        if (
                            !confirm(
                                "Are you sure you want to delete this schedule item?",
                            )
                        ) {
                            return;
                        }

                        fetch(`/schedule/${index}`, { method: "DELETE" })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.status === "success") {
                                    alert("Schedule item deleted.");
                                    renderSchedule(data.schedule);
                                } else {
                                    alert(
                                        "Error deleting item: " + data.message,
                                    );
                                }
                            })
                            .catch((error) => {
                                console.error("Error deleting item:", error);
                                alert("Error deleting item.");
                            });
                    }
                });

                // Audio Upload
                uploadForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    if (!audioFileInput.files.length) {
                        alert("Please select a file to upload.");
                        return;
                    }
                    const formData = new FormData(uploadForm);

                    fetch("/upload_audio", { method: "POST", body: formData })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("File uploaded successfully!");
                                uploadForm.reset();
                                // Refresh the audio files list
                                loadData();
                            } else {
                                alert("Error uploading file: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error uploading file:", error);
                            alert("An error occurred during file upload.");
                        });
                });

                // --- INITIALIZATION ---
                loadData();
                initializeRecorder();
            });
        </script>
    </body>
</html>
