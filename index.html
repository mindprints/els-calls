<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Call Settings Dashboard</title>
        <script src="https://unpkg.com/lamejs@1.2.1/lame.min.js"></script>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
                    "Helvetica Neue", sans-serif;
                margin: 2em;
                background-color: #f4f4f9;
                color: #333;
            }
            h1,
            h3,
            h4 {
                color: #444;
            }
            .section {
                background: #fff;
                padding: 1.5em;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }
            input[type="text"],
            input[type="time"],
            select,
            input[type="file"],
            input[type="password"] {
                width: 100%;
                padding: 8px;
                margin: 6px 0 16px;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #4caf50;
                color: white;
                padding: 12px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
            }
            button:hover {
                background-color: #45a049;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            button.delete {
                background-color: #f44336;
                padding: 5px 10px;
                font-size: 0.8em;
            }
            button.delete:hover {
                background-color: #da190b;
            }
            hr {
                border: 0;
                height: 1px;
                background: #ddd;
                margin: 2em 0;
            }
            .audio-item {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
            }
            .audio-item label {
                flex-grow: 1;
                margin: 0 8px;
            }
            .slot {
                background-color: #e9eef6;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        </style>
    </head>
    <body>
        <div id="app-container">
            <h1>Call Settings Dashboard</h1>

            <!-- General Settings -->
            <div class="section">
                <h3>General Settings</h3>
                <form id="settings-form" onsubmit="return false;">
                    <label for="mil_number">MIL Number:</label>
                    <input type="text" id="mil_number" name="mil_number" />

                    <label for="fallback_number">Fallback Number:</label>
                    <input
                        type="text"
                        id="fallback_number"
                        name="fallback_number"
                    />

                    <label
                        >Default Active Audio (when no schedule matches):</label
                    >
                    <div id="audio-list">
                        <p>Loading audio files...</p>
                    </div>
                    <br />

                    <button type="submit" id="save-settings-btn">
                        Save General Settings
                    </button>
                </form>
            </div>

            <hr />

            <!-- AI Chat Settings -->
            <div class="section">
                <h3>AI Chat Settings</h3>
                <form id="ai-settings-form" onsubmit="return false;">
                    <label for="max_turns">Maximum Conversation Turns:</label>
                    <input type="number" id="max_turns" name="max_turns" min="1" max="10" value="3" />

                    <label for="lang">Language Code:</label>
                    <select id="lang" name="lang">
                        <option value="sv">Swedish (sv)</option>
                        <option value="en">English (en)</option>
                        <option value="no">Norwegian (no)</option>
                        <option value="da">Danish (da)</option>
                    </select>

                    <button type="submit" id="save-ai-settings-btn">
                        Save AI Chat Settings
                    </button>
                </form>
            </div>

            <hr />

            <!-- Schedule Manager -->
            <div class="section">
                <h3>Schedule Manager</h3>
                <form id="schedule-form" onsubmit="return false;">
                    <label for="schedule_audio_file">Action:</label>
                    <select id="schedule_audio_file" required>
                        <option value="AI_VOICE_CHAT">AI Voice Chat</option>
                    </select>

                    <label>Days of Week:</label>
                    <div style="margin: 10px 0;">
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="0" checked> Monday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="1" checked> Tuesday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="2" checked> Wednesday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="3" checked> Thursday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="4" checked> Friday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="5" checked> Saturday</label>
                        <label style="display: inline-block; margin-right: 15px;"><input type="checkbox" name="days" value="6" checked> Sunday</label>
                    </div>

                    <label for="start_time">Start Time (UTC):</label>
                    <input type="time" id="start_time" required />

                    <label for="end_time">End Time (UTC):</label>
                    <input type="time" id="end_time" required />

                    <button type="submit">Add to Schedule</button>
                </form>

                <h4>Current Schedule</h4>
                <div id="schedule-list">
                    <p>Loading schedule...</p>
                </div>
            </div>

            <hr />

            <!-- Record New Audio -->
            <div class="section" id="record-section">
                <h3>Record New Audio</h3>
                <div id="recorder-ui">
                    <button type="button" id="start-record-btn">Start Recording</button>
                    <button type="button" id="stop-record-btn" disabled>Stop Recording</button>
                    <p>
                        <strong>Status:</strong>
                        <span id="record-status">Ready</span>
                    </p>
                    <audio
                        id="preview-player"
                        controls
                        style="display: none; margin-top: 1em; width: 100%"
                    ></audio>
                    <div
                        id="preview-controls"
                        style="display: none; margin-top: 1em"
                    >
                        <button type="button" id="save-record-btn">
                            Save Recording
                        </button>
                        <button
                            type="button"
                            id="discard-record-btn"
                            class="delete"
                        >
                            Discard
                        </button>
                    </div>
                </div>
            </div>

            <hr />

            <!-- Upload Audio -->
            <div class="section">
                <h3>Upload New Audio</h3>
                <form id="upload-form" enctype="multipart/form-data">
                    <label for="audio_file">Audio file (MP3 only):</label><br />
                    <input
                        type="file"
                        id="audio_file"
                        name="audio_file"
                        accept="audio/mpeg"
                    /><br /><br />
                    <button type="submit">Upload</button>
                </form>
            </div>
        </div>

        <script>
            // Authentication is handled by Dokploy platform
            window.addEventListener("DOMContentLoaded", () => {

                // --- ELEMENT SELECTORS ---
                const milNumberInput = document.getElementById("mil_number");
                const fallbackNumberInput =
                    document.getElementById("fallback_number");
                const audioListDiv = document.getElementById("audio-list");

                const uploadForm = document.getElementById("upload-form");
                const audioFileInput = document.getElementById("audio_file");

                const scheduleForm = document.getElementById("schedule-form");
                const scheduleAudioFileSelect = document.getElementById(
                    "schedule_audio_file",
                );
                const startTimeInput = document.getElementById("start_time");
                const endTimeInput = document.getElementById("end_time");
                const scheduleListDiv =
                    document.getElementById("schedule-list");

                const recordSection = document.getElementById("record-section");
                const startRecordBtn =
                    document.getElementById("start-record-btn");
                const stopRecordBtn = document.getElementById("stop-record-btn");
                const recordStatus = document.getElementById("record-status");
                const previewPlayer = document.getElementById("preview-player");
                const previewControls =
                    document.getElementById("preview-controls");
                const saveRecordBtn = document.getElementById("save-record-btn");
                const discardRecordBtn =
                    document.getElementById("discard-record-btn");

                // --- STATE VARIABLES ---
                let mediaRecorder;
                let audioChunks = [];
                let audioBlob;

                // --- DATA LOADING & RENDERING ---
                function loadData() {
                    Promise.all([
                        fetch("/settings").then((res) => res.json()),
                        fetch("/audio_files").then(async (res) => {
                            const text = await res.text();
                            try {
                                return JSON.parse(text);
                            } catch {
                                return [];
                            }
                        }),
                    ])
                        .then(([settings, files]) => {
                            renderAudioLists(settings, files);
                            renderSettingsForm(settings);
                            renderSchedule(settings.SCHEDULE || []);
                        })
                        .catch((error) => {
                            console.error("Error loading initial data:", error);
                            alert("Error loading initial data.");
                        });
                }

                function renderAudioLists(settings, files) {
                    audioListDiv.innerHTML = "";
                    scheduleAudioFileSelect.innerHTML = "";

                    // Add AI Voice Chat option to schedule dropdown
                    const aiOption = document.createElement("option");
                    aiOption.value = "AI_VOICE_CHAT";
                    aiOption.textContent = "AI Voice Chat";
                    scheduleAudioFileSelect.appendChild(aiOption);

                    // Add AI Voice Chat option to default audio selection
                    const aiItemDiv = document.createElement("div");
                    aiItemDiv.className = "audio-item";
                    const aiRadio = document.createElement("input");
                    aiRadio.type = "radio";
                    aiRadio.name = "active_audio";
                    aiRadio.id = "audio-radio-AI_VOICE_CHAT";
                    aiRadio.value = "AI_VOICE_CHAT";
                    if (settings.ACTIVE_AUDIO_FILE === "AI_VOICE_CHAT" || (!settings.ACTIVE_AUDIO_FILE && !files || files.length === 0)) {
                        aiRadio.checked = true;
                    }
                    const aiLabel = document.createElement("label");
                    aiLabel.htmlFor = "audio-radio-AI_VOICE_CHAT";
                    aiLabel.textContent = "AI Voice Chat";
                    aiItemDiv.appendChild(aiRadio);
                    aiItemDiv.appendChild(aiLabel);
                    audioListDiv.appendChild(aiItemDiv);

                    if (!files || files.length === 0) {
                        return;
                    }

                    // Add audio files to schedule dropdown
                    files.forEach((file) => {
                        const option = document.createElement("option");
                        option.value = file;
                        option.textContent = file;
                        scheduleAudioFileSelect.appendChild(option);
                    });

                    // Add audio files to default audio selection
                    files.forEach((file) => {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "audio-item";

                        const radio = document.createElement("input");
                        radio.type = "radio";
                        radio.name = "active_audio";
                        radio.id = `audio-radio-${file}`;
                        radio.value = file;
                        if (file === settings.ACTIVE_AUDIO_FILE) {
                            radio.checked = true;
                        }

                        const label = document.createElement("label");
                        label.htmlFor = `audio-radio-${file}`;
                        label.textContent = file;

                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "Delete";
                        deleteBtn.className = "delete audio-delete";
                        deleteBtn.type = "button";
                        deleteBtn.dataset.filename = file;

                        itemDiv.appendChild(radio);
                        itemDiv.appendChild(label);
                        itemDiv.appendChild(deleteBtn);
                        audioListDiv.appendChild(itemDiv);
                    });
                }

                function renderSettingsForm(settings) {
                    milNumberInput.value = settings.MIL_NUMBER || "";
                    fallbackNumberInput.value = settings.FALLBACK_NUMBER || "";
                    
                    // Render AI settings
                    const maxTurnsInput = document.getElementById("max_turns");
                    const langSelect = document.getElementById("lang");
                    if (maxTurnsInput) maxTurnsInput.value = settings.MAX_TURNS || 3;
                    if (langSelect) langSelect.value = settings.LANG || "sv";
                }

                function renderSchedule(schedule) {
                    scheduleListDiv.innerHTML = "";
                    if (!schedule || schedule.length === 0) {
                        scheduleListDiv.innerHTML =
                            "<p>No scheduled items.</p>";
                        return;
                    }
                    schedule.forEach((slot, index) => {
                        const slotDiv = document.createElement("div");
                        slotDiv.className = "slot";
                        const text = document.createElement("span");
                        const days = slot.days || [];
                        const dayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                        const dayStr = days.length === 7 ? "Every day" : days.map(d => dayNames[d]).join(", ");
                        const action = slot.audio_file === "AI_VOICE_CHAT" ? "AI Voice Chat" : `Play "${slot.audio_file}"`;
                        text.textContent = `${action} from ${slot.start_time} to ${slot.end_time} (${dayStr})`;
                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "Delete";
                        deleteBtn.className = "delete";
                        deleteBtn.dataset.index = index;
                        slotDiv.appendChild(text);
                        slotDiv.appendChild(deleteBtn);
                        scheduleListDiv.appendChild(slotDiv);
                    });
                }

                // --- RECORDER LOGIC ---
                function initializeRecorder() {
                    if (
                        !navigator.mediaDevices ||
                        !navigator.mediaDevices.getUserMedia
                    ) {
                        recordSection.innerHTML =
                            '<h3>Recording not supported</h3><p>Direct audio recording is not available on this browser (it requires HTTPS and a modern browser).</p>';
                        return;
                    }
                    startRecordBtn.addEventListener("click", startRecording);
                    stopRecordBtn.addEventListener("click", stopRecording);
                    saveRecordBtn.addEventListener("click", saveRecording);
                    discardRecordBtn.addEventListener(
                        "click",
                        resetRecordingState,
                    );
                    resetRecordingState();
                }

                function resetRecordingState() {
                    startRecordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                    saveRecordBtn.disabled = true;
                    discardRecordBtn.disabled = true;
                    recordStatus.textContent = "Ready";
                    previewPlayer.style.display = "none";
                    previewControls.style.display = "none";
                    if (previewPlayer.src) {
                        URL.revokeObjectURL(previewPlayer.src);
                    }
                    previewPlayer.removeAttribute("src");
                    audioChunks = [];
                    audioBlob = null;
                }

                function startRecording() {
                    navigator.mediaDevices
                        .getUserMedia({ audio: true })
                        .then((stream) => {
                            mediaRecorder = new MediaRecorder(stream);
                            mediaRecorder.ondataavailable = (event) => {
                                audioChunks.push(event.data);
                            };
                            mediaRecorder.onstop = () => {
                                audioBlob = new Blob(audioChunks, {
                                    type: "audio/wav",
                                });
                                const audioUrl =
                                    URL.createObjectURL(audioBlob);
                                previewPlayer.src = audioUrl;
                                previewPlayer.style.display = "block";
                                previewControls.style.display = "block";
                                saveRecordBtn.disabled = false;
                                discardRecordBtn.disabled = false;
                                recordStatus.textContent = "Preview Ready";
                            };
                            startRecordBtn.disabled = true;
                            stopRecordBtn.disabled = false;
                            recordStatus.textContent = "Recording...";
                            mediaRecorder.start();
                        })
                        .catch((err) => {
                            console.error("Error accessing microphone:", err);
                            alert(
                                "Could not access microphone. Please check browser permissions.",
                            );
                        });
                }

                function stopRecording() {
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                        mediaRecorder.stream
                            .getTracks()
                            .forEach((track) => track.stop());
                    }
                    stopRecordBtn.disabled = true;
                }

                function saveRecording() {
                    const filename = prompt(
                        "Please enter a filename for your recording (without extension):",
                    );
                    if (filename && filename.trim()) {
                        encodeAndUpload(audioBlob, `${filename.trim()}.mp3`);
                    } else if (filename !== null) {
                        alert("Filename cannot be empty.");
                    }
                }

                function encodeAndUpload(blob, filename) {
                    recordStatus.textContent = "Encoding to MP3...";
                    saveRecordBtn.disabled = true;
                    discardRecordBtn.disabled = true;

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const audioContext = new (window.AudioContext ||
                            window.webkitAudioContext)();
                        audioContext
                            .decodeAudioData(event.target.result)
                            .then((buffer) => {
                                const mp3encoder = new lamejs.Mp3Encoder(
                                    1,
                                    buffer.sampleRate,
                                    128,
                                );
                                const samples = buffer.getChannelData(0);
                                const mp3Data = [];
                                const sampleBlockSize = 1152;

                                for (
                                    let i = 0;
                                    i < samples.length;
                                    i += sampleBlockSize
                                ) {
                                    const sampleChunk = samples.subarray(
                                        i,
                                        i + sampleBlockSize,
                                    );
                                    const mp3buf =
                                        mp3encoder.encodeBuffer(sampleChunk);
                                    if (mp3buf.length > 0) {
                                        mp3Data.push(mp3buf);
                                    }
                                }
                                const end = mp3encoder.flush();
                                if (end.length > 0) {
                                    mp3Data.push(end);
                                }

                                const mp3Blob = new Blob(mp3Data, {
                                    type: "audio/mpeg",
                                });
                                const formData = new FormData();
                                formData.append("audio_file", mp3Blob, filename);

                                fetch("/upload_audio", {
                                    method: "POST",
                                    body: formData,
                                })
                                    .then((res) => res.json())
                                    .then((data) => {
                                        if (data.status === "success") {
                                            alert("Recording saved successfully!");
                                            loadData();
                                        } else {
                                            alert("Error saving: " + data.message);
                                        }
                                        resetRecordingState();
                                    })
                                    .catch((error) => {
                                        console.error("Upload error:", error);
                                        alert("Failed to upload recording.");
                                        resetRecordingState();
                                    });
                            })
                            .catch((err) => {
                                console.error("Audio decode error:", err);
                                alert("Failed to process audio.");
                                resetRecordingState();
                            });
                    };
                    reader.readAsArrayBuffer(blob);
                }

                // --- EVENT LISTENERS ---
                document.getElementById("save-settings-btn").addEventListener("click", () => {
                    const selectedAudio = document.querySelector(
                        'input[name="active_audio"]:checked',
                    );
                    const newData = {
                        MIL_NUMBER: milNumberInput.value,
                        FALLBACK_NUMBER: fallbackNumberInput.value,
                        ACTIVE_AUDIO_FILE: selectedAudio
                            ? selectedAudio.value
                            : null,
                    };

                    fetch("/settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newData),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Settings saved successfully!");
                                loadData();
                            } else {
                                alert("Error saving settings: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving settings:", error);
                            alert("Error saving settings.");
                        });
                });

                document.getElementById("save-ai-settings-btn").addEventListener("click", () => {
                    const maxTurnsInput = document.getElementById("max_turns");
                    const langSelect = document.getElementById("lang");
                    const newData = {
                        MAX_TURNS: parseInt(maxTurnsInput.value) || 3,
                        LANG: langSelect.value || "sv",
                    };

                    fetch("/settings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newData),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("AI Chat settings saved successfully!");
                                loadData();
                            } else {
                                alert("Error saving AI settings: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving AI settings:", error);
                            alert("Error saving AI settings.");
                        });
                });

                audioListDiv.addEventListener("click", (event) => {
                    const target = event.target;
                    if (target.classList.contains("audio-delete")) {
                        const filename = target.dataset.filename;
                        if (
                            !confirm(
                                `Are you sure you want to delete "${filename}"?`,
                            )
                        ) {
                            return;
                        }

                        fetch(`/audio/${filename}`, { method: "DELETE" })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.status === "success") {
                                    alert(data.message);
                                    loadData();
                                } else {
                                    alert(`Error: ${data.message}`);
                                }
                            })
                            .catch((error) => {
                                console.error(
                                    "Error deleting audio file:",
                                    error,
                                );
                                alert(
                                    "An error occurred while trying to delete the file.",
                                );
                            });
                    }
                });

                scheduleForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value));
                    if (selectedDays.length === 0) {
                        alert("Please select at least one day of the week.");
                        return;
                    }
                    const newSlot = {
                        audio_file: scheduleAudioFileSelect.value,
                        days: selectedDays,
                        start_time: startTimeInput.value,
                        end_time: endTimeInput.value,
                    };

                    fetch("/schedule", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newSlot),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Schedule updated!");
                                renderSchedule(data.schedule);
                                scheduleForm.reset();
                            } else {
                                alert(
                                    "Error updating schedule: " + data.message,
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Error updating schedule:", error);
                            alert("Error updating schedule.");
                        });
                });

                scheduleListDiv.addEventListener("click", (event) => {
                    if (event.target.classList.contains("delete")) {
                        const index = event.target.dataset.index;
                        if (
                            !confirm(
                                "Are you sure you want to delete this schedule item?",
                            )
                        ) {
                            return;
                        }

                        fetch(`/schedule/${index}`, { method: "DELETE" })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data.status === "success") {
                                    alert("Schedule item deleted.");
                                    renderSchedule(data.schedule);
                                } else {
                                    alert(
                                        "Error deleting item: " + data.message,
                                    );
                                }
                            })
                            .catch((error) => {
                                console.error("Error deleting item:", error);
                                alert("Error deleting item.");
                            });
                    }
                });

                uploadForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    if (!audioFileInput.files.length) {
                        alert("Please select a file to upload.");
                        return;
                    }
                    const formData = new FormData(uploadForm);

                    fetch("/upload_audio", { method: "POST", body: formData })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("File uploaded successfully!");
                                uploadForm.reset();
                                loadData();
                            } else {
                                alert("Error uploading file: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error uploading file:", error);
                            alert("An error occurred during file upload.");
                        });
                });

                // --- INITIALIZATION ---
                initializeRecorder();
                loadData(); // Load initial data after setup
            });
        </script>
    </body>
</html>
