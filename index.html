<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Settings Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lamejs@1.2.1/lame.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a premium feel */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }

        .input-field {
            transition: all 0.2s;
        }

        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Top Navigation / Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-wave-square text-indigo-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight text-slate-900">Call Manager</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="save-status"
                        class="text-xs font-medium text-slate-400 uppercase tracking-wider opacity-0 transition-opacity duration-500">
                        All changes saved
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- LEFT COLUMN: Settings & Schedule -->
            <div class="lg:col-span-7 space-y-8">

                <!-- General Settings -->
                <section class="glass-panel rounded-2xl shadow-sm p-6">
                    <div class="flex items-center mb-6">
                        <div class="bg-indigo-100 p-2 rounded-lg mr-3 text-indigo-600">
                            <i class="fa-solid fa-sliders"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-slate-900">General Configuration</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">MIL Number</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <i class="fa-solid fa-phone"></i>
                                </span>
                                <input type="text" id="mil_number"
                                    class="input-field pl-10 w-full rounded-lg border-slate-300 border p-2.5 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="+46...">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Fallback Number</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <i class="fa-solid fa-share"></i>
                                </span>
                                <input type="text" id="fallback_number"
                                    class="input-field pl-10 w-full rounded-lg border-slate-300 border p-2.5 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="+46...">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AI Settings -->
                <section class="glass-panel rounded-2xl shadow-sm p-6">
                    <div class="flex items-center mb-6">
                        <div class="bg-purple-100 p-2 rounded-lg mr-3 text-purple-600">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-slate-900">AI Assistant</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Max Conversation Turns</label>
                            <input type="number" id="max_turns" min="1" max="10"
                                class="input-field w-full rounded-lg border-slate-300 border p-2.5 text-sm focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Language</label>
                            <select id="lang"
                                class="input-field w-full rounded-lg border-slate-300 border p-2.5 text-sm focus:ring-purple-500 focus:border-purple-500 bg-white">
                                <option value="sv">ðŸ‡¸ðŸ‡ª Swedish</option>
                                <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                                <option value="no">ðŸ‡³ðŸ‡´ Norwegian</option>
                                <option value="da">ðŸ‡©ðŸ‡° Danish</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Schedule Manager -->
                <section class="glass-panel rounded-2xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="bg-emerald-100 p-2 rounded-lg mr-3 text-emerald-600">
                                <i class="fa-regular fa-calendar-days"></i>
                            </div>
                            <h2 class="text-lg font-semibold text-slate-900">Schedule</h2>
                        </div>
                        <button onclick="toggleScheduleForm()"
                            class="text-sm bg-emerald-50 text-emerald-600 hover:bg-emerald-100 px-3 py-1.5 rounded-md font-medium transition-colors">
                            <i class="fa-solid fa-plus mr-1"></i> Add Rule
                        </button>
                    </div>

                    <!-- Add Schedule Form (Hidden by default) -->
                    <div id="schedule-form-container"
                        class="hidden bg-slate-50 rounded-xl p-4 mb-6 border border-slate-200">
                        <form id="schedule-form" onsubmit="return false;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-medium text-slate-500 uppercase mb-1">Action</label>
                                    <select id="schedule_audio_file"
                                        class="w-full rounded-md border-slate-300 text-sm p-2">
                                        <option value="AI_VOICE_CHAT">ðŸ¤– AI Voice Chat</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Start
                                        Time</label>
                                    <input type="time" id="start_time" required
                                        class="w-full rounded-md border-slate-300 text-sm p-2">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">End
                                        Time</label>
                                    <input type="time" id="end_time" required
                                        class="w-full rounded-md border-slate-300 text-sm p-2">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-xs font-medium text-slate-500 uppercase mb-2">Days
                                    Active</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="0" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Mon</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="1" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Tue</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="2" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Wed</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="3" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Thu</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="4" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Fri</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="5" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Sat</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="checkbox" name="days" value="6" checked class="peer sr-only">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 transition-all select-none">Sun</span>
                                    </label>
                                </div>
                            </div>

                            <div class="flex justify-end gap-2">
                                <button onclick="toggleScheduleForm()"
                                    class="px-4 py-2 text-sm text-slate-600 hover:text-slate-800">Cancel</button>
                                <button type="submit"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition-colors">Save
                                    Rule</button>
                            </div>
                        </form>
                    </div>

                    <div id="schedule-list" class="space-y-3">
                        <!-- Schedule items will be injected here -->
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                                <div class="space-y-2">
                                    <div class="h-4 bg-slate-200 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- RIGHT COLUMN: Audio Management -->
            <div class="lg:col-span-5 space-y-8">

                <!-- Audio Library -->
                <section class="glass-panel rounded-2xl shadow-sm p-6 flex flex-col h-full">
                    <div class="flex items-center mb-6">
                        <div class="bg-rose-100 p-2 rounded-lg mr-3 text-rose-600">
                            <i class="fa-solid fa-music"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-slate-900">Audio Library</h2>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-slate-200 mb-6">
                        <button onclick="switchTab('library')" id="tab-library"
                            class="flex-1 pb-3 text-sm font-medium text-rose-600 border-b-2 border-rose-600">Library</button>
                        <button onclick="switchTab('upload')" id="tab-upload"
                            class="flex-1 pb-3 text-sm font-medium text-slate-500 hover:text-slate-700">Upload</button>
                        <button onclick="switchTab('record')" id="tab-record"
                            class="flex-1 pb-3 text-sm font-medium text-slate-500 hover:text-slate-700">Record</button>
                    </div>

                    <!-- Tab Content: Library -->
                    <div id="content-library" class="space-y-4">
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Default Active
                            Audio</div>
                        <div id="audio-list" class="space-y-2">
                            <!-- Audio items injected here -->
                        </div>
                    </div>

                    <!-- Tab Content: Upload -->
                    <div id="content-upload" class="hidden">
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors cursor-pointer"
                            onclick="document.getElementById('audio_file').click()">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3"></i>
                            <p class="text-sm text-slate-600 font-medium">Click to upload MP3</p>
                            <p class="text-xs text-slate-400 mt-1">Max 10MB</p>
                            <input type="file" id="audio_file" accept="audio/mpeg" class="hidden">
                        </div>

                        <!-- Upload Progress -->
                        <div id="upload-progress-container" class="hidden mt-4">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-medium text-slate-600">Uploading...</span>
                                <span id="upload-percentage" class="text-slate-500">0%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div id="upload-bar" class="bg-rose-500 h-2 rounded-full transition-all duration-300"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Record -->
                    <div id="content-record" class="hidden flex flex-col items-center justify-center py-4">
                        <div id="record-visualizer"
                            class="h-24 w-full bg-slate-100 rounded-xl mb-6 flex items-center justify-center overflow-hidden relative">
                            <div class="absolute inset-0 flex items-center justify-center space-x-1" id="wave-bars">
                                <!-- Bars generated by JS -->
                            </div>
                            <span id="record-timer" class="relative z-10 font-mono text-2xl text-slate-400">00:00</span>
                        </div>

                        <div class="flex gap-4">
                            <button id="start-record-btn"
                                class="w-16 h-16 rounded-full bg-rose-500 hover:bg-rose-600 text-white shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
                                <i class="fa-solid fa-microphone text-2xl"></i>
                            </button>
                            <button id="stop-record-btn" disabled
                                class="hidden w-16 h-16 rounded-full bg-slate-800 hover:bg-slate-900 text-white shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
                                <i class="fa-solid fa-stop text-2xl"></i>
                            </button>
                        </div>

                        <p id="record-status" class="mt-4 text-sm text-slate-500 font-medium">Ready to record</p>

                        <!-- Preview & Save -->
                        <div id="preview-container"
                            class="hidden w-full mt-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-xs font-bold text-slate-400 uppercase">Preview</span>
                                <button id="discard-record-btn"
                                    class="text-xs text-red-500 hover:text-red-700 font-medium">Discard</button>
                            </div>
                            <audio id="preview-player" controls class="w-full h-8 mb-4"></audio>
                            <button id="save-record-btn"
                                class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg text-sm font-medium shadow-sm">
                                Save Recording
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // --- UTILS ---
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const showStatus = (msg, type = 'success') => {
            const el = document.getElementById('save-status');
            el.textContent = msg;
            el.className = `text-xs font-medium uppercase tracking-wider opacity-100 transition-opacity duration-500 ${type === 'error' ? 'text-red-500' : 'text-emerald-500'}`;
            setTimeout(() => {
                el.classList.add('opacity-0');
            }, 3000);
        };

        // --- STATE ---
        let currentSettings = {};
        let audioFiles = [];
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let recordStartTime;
        let recordTimerInterval;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupAutoSave();
            setupTabs();
            setupRecorder();
            setupUpload();
        });

        function loadData() {
            Promise.all([
                fetch("/settings").then(res => res.json()),
                fetch("/audio_files").then(async res => {
                    try { return JSON.parse(await res.text()); } catch { return []; }
                })
            ]).then(([settings, files]) => {
                currentSettings = settings;
                audioFiles = files;
                renderAll();
            }).catch(err => {
                console.error(err);
                showStatus('Error loading data', 'error');
            });
        }

        function renderAll() {
            // General
            document.getElementById('mil_number').value = currentSettings.MIL_NUMBER || '';
            document.getElementById('fallback_number').value = currentSettings.FALLBACK_NUMBER || '';

            // AI
            document.getElementById('max_turns').value = currentSettings.MAX_TURNS || 3;
            document.getElementById('lang').value = currentSettings.LANG || 'sv';

            // Audio List
            renderAudioList();

            // Schedule
            renderSchedule();
        }

        // --- AUTO SAVE LOGIC ---
        function setupAutoSave() {
            const saveSettings = debounce(() => {
                const newData = {
                    MIL_NUMBER: document.getElementById('mil_number').value,
                    FALLBACK_NUMBER: document.getElementById('fallback_number').value,
                    MAX_TURNS: parseInt(document.getElementById('max_turns').value) || 3,
                    LANG: document.getElementById('lang').value,
                    ACTIVE_AUDIO_FILE: document.querySelector('input[name="active_audio"]:checked')?.value || null
                };

                // Optimistic update
                currentSettings = { ...currentSettings, ...newData };

                fetch("/settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newData)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') showStatus('Changes saved');
                        else showStatus('Save failed', 'error');
                    })
                    .catch(() => showStatus('Network error', 'error'));
            }, 500);

            // Attach listeners
            ['mil_number', 'fallback_number', 'max_turns'].forEach(id => {
                document.getElementById(id).addEventListener('input', saveSettings);
            });
            document.getElementById('lang').addEventListener('change', saveSettings);
        }

        // --- AUDIO LIST & PLAYBACK ---
        function renderAudioList() {
            const container = document.getElementById('audio-list');
            const scheduleSelect = document.getElementById('schedule_audio_file');

            container.innerHTML = '';
            scheduleSelect.innerHTML = '<option value="AI_VOICE_CHAT">ðŸ¤– AI Voice Chat</option>';

            // Helper to create row
            const createRow = (value, label, isAi = false) => {
                const isChecked = currentSettings.ACTIVE_AUDIO_FILE === value || (!currentSettings.ACTIVE_AUDIO_FILE && isAi);

                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg border ${isChecked ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200 bg-white'} transition-colors`;

                div.innerHTML = `
                    <div class="flex items-center flex-1 min-w-0">
                        <input type="radio" name="active_audio" value="${value}" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <div class="ml-3 flex items-center truncate">
                            <span class="text-sm font-medium ${isChecked ? 'text-indigo-900' : 'text-slate-700'} truncate">${label}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-2">
                        ${!isAi ? `
                            <button onclick="playAudio('${value}', this)" class="text-slate-400 hover:text-indigo-600 p-1 rounded transition-colors">
                                <i class="fa-solid fa-play"></i>
                            </button>
                            <button onclick="deleteAudio('${value}')" class="text-slate-400 hover:text-red-500 p-1 rounded transition-colors">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        ` : '<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">Default</span>'}
                    </div>
                `;

                // Add change listener manually to the radio
                const radio = div.querySelector('input[type="radio"]');
                radio.addEventListener('change', () => {
                    // Update UI immediately
                    document.querySelectorAll('#audio-list > div').forEach(el => {
                        el.className = el.className.replace('border-indigo-500 bg-indigo-50', 'border-slate-200 bg-white');
                        el.querySelector('span').className = el.querySelector('span').className.replace('text-indigo-900', 'text-slate-700');
                    });
                    div.className = div.className.replace('border-slate-200 bg-white', 'border-indigo-500 bg-indigo-50');
                    div.querySelector('span').className = div.querySelector('span').className.replace('text-slate-700', 'text-indigo-900');

                    // Trigger save
                    const event = new Event('input');
                    document.getElementById('mil_number').dispatchEvent(event); // Re-use existing saver
                });

                return div;
            };

            // AI Option
            container.appendChild(createRow('AI_VOICE_CHAT', 'AI Voice Chat', true));

            // Files
            audioFiles.forEach(file => {
                container.appendChild(createRow(file, file));

                // Add to schedule dropdown
                const opt = document.createElement('option');
                opt.value = file;
                opt.textContent = `ðŸŽµ ${file}`;
                scheduleSelect.appendChild(opt);
            });
        }

        let currentAudio = null;
        let currentBtn = null;

        window.playAudio = (filename, btn) => {
            if (currentAudio) {
                currentAudio.pause();
                currentBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
                if (currentBtn === btn) {
                    currentAudio = null;
                    currentBtn = null;
                    return;
                }
            }

            const audio = new Audio(`/audio/${filename}`);
            audio.play();
            btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            currentAudio = audio;
            currentBtn = btn;

            audio.onended = () => {
                btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                currentAudio = null;
                currentBtn = null;
            };
        };

        window.deleteAudio = (filename) => {
            if (!confirm(`Delete ${filename}?`)) return;
            fetch(`/audio/${filename}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadData();
                        showStatus('File deleted');
                    } else {
                        alert(data.message);
                    }
                });
        };

        // --- UPLOAD ---
        function setupUpload() {
            const input = document.getElementById('audio_file');
            input.addEventListener('change', () => {
                if (input.files.length > 0) uploadFile(input.files[0]);
            });
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('audio_file', file);

            const xhr = new XMLHttpRequest();
            const progressBar = document.getElementById('upload-bar');
            const progressText = document.getElementById('upload-percentage');
            const progressContainer = document.getElementById('upload-progress-container');

            progressContainer.classList.remove('hidden');

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = percent + '%';
                }
            });

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.status === 'success') {
                            showStatus('Upload complete');
                            loadData();
                            switchTab('library');
                        } else {
                            alert('Upload failed: ' + data.message);
                        }
                    } else {
                        alert('Upload failed');
                    }
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        progressBar.style.width = '0%';
                        document.getElementById('audio_file').value = '';
                    }, 1000);
                }
            };

            xhr.open('POST', '/upload_audio', true);
            xhr.send(formData);
        }

        // --- RECORDER ---
        function setupRecorder() {
            const startBtn = document.getElementById('start-record-btn');
            const stopBtn = document.getElementById('stop-record-btn');
            const saveBtn = document.getElementById('save-record-btn');
            const discardBtn = document.getElementById('discard-record-btn');

            // Check for HTTPS or localhost
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('content-record').innerHTML = `
                    <div class="text-center p-6 bg-amber-50 rounded-xl border border-amber-200">
                        <i class="fa-solid fa-lock text-3xl text-amber-500 mb-3"></i>
                        <h3 class="text-lg font-medium text-amber-800 mb-2">Secure Connection Required</h3>
                        <p class="text-sm text-amber-700">Microphone access requires HTTPS. Please access this dashboard via a secure connection.</p>
                    </div>
                `;
                return;
            }

            startBtn.addEventListener('click', async () => {
                try {
                    // Explicitly request permissions if not already granted
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const url = URL.createObjectURL(audioBlob);
                        document.getElementById('preview-player').src = url;
                        document.getElementById('preview-container').classList.remove('hidden');
                        document.getElementById('record-status').textContent = 'Recording finished';
                        stopWaveAnimation();
                    };

                    mediaRecorder.start();
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    document.getElementById('record-status').textContent = 'Recording...';
                    startTimer();
                    startWaveAnimation();

                } catch (err) {
                    console.error("Mic Error:", err);
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            });

            stopBtn.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(t => t.stop());
                }
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                stopTimer();
            });

            discardBtn.addEventListener('click', () => {
                document.getElementById('preview-container').classList.add('hidden');
                document.getElementById('record-status').textContent = 'Ready to record';
                document.getElementById('record-timer').textContent = '00:00';
                if (document.getElementById('preview-player').src) {
                    URL.revokeObjectURL(document.getElementById('preview-player').src);
                    document.getElementById('preview-player').src = '';
                }
            });

            saveBtn.addEventListener('click', () => {
                const name = prompt('Filename (without .mp3):');
                if (!name) return;

                saveBtn.textContent = 'Processing...';
                saveBtn.disabled = true;

                const reader = new FileReader();
                reader.onload = function (event) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioContext.decodeAudioData(event.target.result).then(buffer => {
                        const mp3encoder = new lamejs.Mp3Encoder(1, buffer.sampleRate, 128);
                        const samples = buffer.getChannelData(0);
                        const mp3Data = [];
                        const sampleBlockSize = 1152;
                        for (let i = 0; i < samples.length; i += sampleBlockSize) {
                            const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                            const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                            if (mp3buf.length > 0) mp3Data.push(mp3buf);
                        }
                        const end = mp3encoder.flush();
                        if (end.length > 0) mp3Data.push(end);

                        const mp3Blob = new Blob(mp3Data, { type: 'audio/mpeg' });
                        const file = new File([mp3Blob], name + '.mp3', { type: 'audio/mpeg' });

                        // Manually trigger upload logic to ensure UI updates
                        const formData = new FormData();
                        formData.append('audio_file', file);

                        const xhr = new XMLHttpRequest();
                        // Re-use upload progress UI
                        const progressBar = document.getElementById('upload-bar');
                        const progressText = document.getElementById('upload-percentage');
                        const progressContainer = document.getElementById('upload-progress-container');

                        // Switch tab to show progress
                        switchTab('upload');
                        progressContainer.classList.remove('hidden');

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressBar.style.width = percent + '%';
                                progressText.textContent = percent + '%';
                            }
                        });

                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    const data = JSON.parse(xhr.responseText);
                                    if (data.status === 'success') {
                                        showStatus('Recording saved');
                                        loadData();
                                        switchTab('library');

                                        // Reset Recorder UI
                                        saveBtn.textContent = 'Save Recording';
                                        saveBtn.disabled = false;
                                        discardBtn.click();
                                    } else {
                                        alert('Save failed: ' + data.message);
                                        switchTab('record'); // Go back to record tab on failure
                                        saveBtn.textContent = 'Save Recording';
                                        saveBtn.disabled = false;
                                    }
                                } else {
                                    alert('Save failed');
                                    switchTab('record');
                                    saveBtn.textContent = 'Save Recording';
                                    saveBtn.disabled = false;
                                }
                                setTimeout(() => {
                                    progressContainer.classList.add('hidden');
                                    progressBar.style.width = '0%';
                                }, 1000);
                            }
                        };
                        xhr.open('POST', '/upload_audio', true);
                        xhr.send(formData);
                    });
                };
                reader.readAsArrayBuffer(audioBlob);
            });
        }

        function startTimer() {
            recordStartTime = Date.now();
            recordTimerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - recordStartTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('record-timer').textContent = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(recordTimerInterval);
        }

        function startWaveAnimation() {
            const container = document.getElementById('wave-bars');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'w-1 bg-rose-400 rounded-full animate-pulse';
                bar.style.height = '20%';
                bar.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                container.appendChild(bar);
            }
            // Simulate activity
            window.waveInterval = setInterval(() => {
                Array.from(container.children).forEach(bar => {
                    bar.style.height = (20 + Math.random() * 60) + '%';
                });
            }, 100);
        }

        function stopWaveAnimation() {
            clearInterval(window.waveInterval);
            document.getElementById('wave-bars').innerHTML = '';
        }

        // --- SCHEDULE ---
        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            const schedule = currentSettings.SCHEDULE || [];

            if (schedule.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">No active schedule rules</div>';
                return;
            }

            list.innerHTML = '';
            schedule.forEach((slot, index) => {
                const dayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                const days = slot.days.map(d => dayNames[d]).join(", ");
                const isEveryday = slot.days.length === 7;

                const div = document.createElement('div');
                div.className = 'bg-white border border-slate-200 rounded-lg p-4 flex justify-between items-center shadow-sm';
                div.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-xs font-bold uppercase tracking-wider ${slot.audio_file === 'AI_VOICE_CHAT' ? 'text-purple-600 bg-purple-50' : 'text-indigo-600 bg-indigo-50'} px-2 py-0.5 rounded">
                                ${slot.audio_file === 'AI_VOICE_CHAT' ? 'AI Chat' : 'Play Audio'}
                            </span>
                            <span class="text-sm font-semibold text-slate-900">${slot.start_time} - ${slot.end_time}</span>
                        </div>
                        <div class="text-xs text-slate-500">
                            ${slot.audio_file !== 'AI_VOICE_CHAT' ? `<i class="fa-solid fa-music mr-1"></i> ${slot.audio_file} â€¢ ` : ''}
                            <i class="fa-regular fa-calendar mr-1"></i> ${isEveryday ? 'Every day' : days}
                        </div>
                    </div>
                    <button onclick="deleteSchedule(${index})" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        window.toggleScheduleForm = () => {
            const form = document.getElementById('schedule-form-container');
            form.classList.toggle('hidden');
        };

        document.getElementById('schedule-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value));
            if (selectedDays.length === 0) { alert('Select at least one day'); return; }

            const newSlot = {
                audio_file: document.getElementById('schedule_audio_file').value,
                days: selectedDays,
                start_time: document.getElementById('start_time').value,
                end_time: document.getElementById('end_time').value
            };

            fetch("/schedule", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newSlot)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentSettings.SCHEDULE = data.schedule;
                        renderSchedule();
                        toggleScheduleForm();
                        showStatus('Rule added');
                    } else {
                        alert(data.message);
                    }
                });
        });

        window.deleteSchedule = (index) => {
            if (!confirm('Delete this rule?')) return;
            fetch(`/schedule/${index}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentSettings.SCHEDULE = data.schedule;
                        renderSchedule();
                        showStatus('Rule deleted');
                    }
                });
        };

        // --- TABS ---
        window.switchTab = (tab) => {
            ['library', 'upload', 'record'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);

                if (t === tab) {
                    btn.className = 'flex-1 pb-3 text-sm font-medium text-rose-600 border-b-2 border-rose-600';
                    content.classList.remove('hidden');
                } else {
                    btn.className = 'flex-1 pb-3 text-sm font-medium text-slate-500 hover:text-slate-700';
                    content.classList.add('hidden');
                }
            });
        };

    </script>
</body>

</html>